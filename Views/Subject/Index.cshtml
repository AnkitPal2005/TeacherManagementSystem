

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>📚 Subject Management</h1>
        <button class="btn btn-success btnAdd">
            + Add Subject
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body" id="tableContainer">
            
        </div>
    </div>

</div>

<!-- Subject Modal -->
<div class="modal fade" id="subjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    Add Subject
                </h5>

                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal">
                </button>
            </div>

            <div class="modal-body" id="modalBody">
            </div>

            <div class="modal-footer">

                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Close
                </button>

                <button type="button"
                        class="btn btn-primary"
                        id="btnSave">
                    Save Subject
                </button>

            </div>

        </div>
    </div>
</div>
@section Scripts{
  <script>
       // var currentEditID=null;
              $(function () {
             loadSubjects();

          // ADD SUBJECT BUTTON
            $(document).on("click", ".btnAdd", function () {
                 // currentEditID=null;
                console.log("btn add click");


                $("#modalTitle").text("Add Subject");
                $.get("/Subject/LoadForm", function (html) {
                    $("#modalBody").html(html);
                    $("#btnSave").data("url","/Subject/Create");
                    $("#subjectModal").modal("show");
                });
            });

            // Save Button Click - FIX: Check if already saving
            $(document).off("click", "#btnSave")
                .on("click", "#btnSave", function () {
                    
                    // Prevent double submission
                    if ($(this).prop('disabled')) {
                        return false;
                    }

                    // var id = $("#subjectId").val() || 0;
                    var subjectObj = {
                        // Id: parseInt(id) || 0,
                        Names: $("#subjectName").val(),
                        Code: $("#subjectCode").val()
                    };
                    console.log(subjectObj);
                    if (!subjectObj.Names.trim() || !subjectObj.Code.toString().trim()) {
                        alert("Please fill in all fields.");
                        return;
                    }

                    // var url = subjectObj.Id === 0 ? "/Subject/Create" : "/Subject/Edit";
                     var $btn = $(this);
                     var url=$(this).data("url");
                    // Disable button to prevent double click
               
                    $btn.prop('disabled', true).text('Saving...');

                    $.ajax({
                        url: url,
                        type: "POST",
                        data: subjectObj,
                        success: function () {
                            $("#subjectModal").modal("hide");
                            loadSubjects();
                            $btn.prop('disabled', false).text('Save');
                        },
                        error: function (xhr) {
                            alert(xhr.responseText);
                            $btn.prop('disabled', false).text('Save');
                        }
                    });
        });

        //Edit Button Click
        $(document).off("click", ".btn-subject-edit")
            .on("click", ".btn-subject-edit", function () {
                var id = $(this).data("id");
                 // currentEditID=$(this).data("id");
                $("#modalTitle").text("Edit Subject");
                $.get("/Subject/EditPartial", {id: id}, function (html) {
                    $("#modalBody").html(html);
                     $("#btnSave").data("url","/Subject/Edit/"+id);
                    $("#subjectModal").modal("show");
                });
            });

        // Delete Button Click
        $(document).off("click", ".btn-subject-delete")
            .on("click", ".btn-subject-delete", function () {
                var id = $(this).data("id");
                $.ajax({
                    url: "/Subject/Delete",
                    type: "POST",
                    data: { sid: id },
                    success: function () {
                        loadSubjects();
                    },
                    error: function (xhr) {
                        alert(xhr.responseText);
                    }
                });
            });
            });
        function loadSubjects() {
            $.ajax({
                url: "/Subject/LoadSubjects",
                type: "GET",
                success: function (html) {
                    $("#tableContainer").html(html);
                },
                error: function () {
                    $("#tableContainer").html("<div class='text-danger'>Failed to load subjects.</div>");
                }
            });
        }
        
  </script>

}  

